name: Installation Test

# Only run on releases and manual dispatch - E2E tests cover regular CI
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual verification'

concurrency:
  group: installation-${{ github.ref }}
  cancel-in-progress: true

env:
  CGO_ENABLED: 1
  BUILD_TAGS: fts5
  OLLAMA_MODEL: nomic-embed-text

jobs:
  # Use reusable build workflow for all platforms
  build:
    uses: ./.github/workflows/build-reusable.yml
    with:
      retention-days: 1
      platforms: '["linux-x64", "linux-arm64", "macos-x64", "macos-arm64", "windows-x64"]'

  # Test installation on clean macOS
  test-macos:
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: mycelicmemory-macos-arm64
          path: ./bin

      - name: Test binary execution
        run: |
          chmod +x ./bin/mycelicmemory-macos-arm64
          ./bin/mycelicmemory-macos-arm64 --version
          ./bin/mycelicmemory-macos-arm64 --help

      - name: Cache Ollama
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-${{ env.OLLAMA_MODEL }}
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Install and start Ollama
        run: |
          brew install ollama
          ollama serve &
          sleep 5

          if ! ollama list | grep -q "$OLLAMA_MODEL"; then
            ollama pull $OLLAMA_MODEL
          fi
          ollama list

      - name: Install and start Qdrant
        run: |
          brew install qdrant/tap/qdrant
          qdrant &
          sleep 5

          for i in {1..30}; do
            if curl -s http://localhost:6333/readyz > /dev/null; then
              echo "Qdrant ready"
              break
            fi
            sleep 1
          done

      - name: Test doctor command (with dependencies)
        run: |
          export OLLAMA_HOST=http://localhost:11434
          export QDRANT_HOST=http://localhost:6333
          ./bin/mycelicmemory-macos-arm64 doctor

      - name: Test database initialization
        run: |
          export HOME=$(mktemp -d)
          export OLLAMA_HOST=http://localhost:11434
          export QDRANT_HOST=http://localhost:6333
          ./bin/mycelicmemory-macos-arm64 doctor
          ls -la $HOME/.mycelicmemory/ || echo "Config dir check"

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test npm installation from GitHub
        run: |
          npm install -g github:MycelicMemory/mycelicmemory#${{ github.sha }}
          which mycelicmemory || echo "mycelicmemory not in PATH"
          mycelicmemory --version || echo "Version check with npm wrapper"

  # Test installation on clean Ubuntu
  test-linux:
    needs: build
    runs-on: ubuntu-latest
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
          - 6334:6334
        options: >-
          --health-cmd "curl -f http://localhost:6333/readyz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux x64 binary
        uses: actions/download-artifact@v4
        with:
          name: mycelicmemory-linux-x64
          path: ./bin

      - name: Test binary execution
        run: |
          chmod +x ./bin/mycelicmemory-linux-x64
          ./bin/mycelicmemory-linux-x64 --version
          ./bin/mycelicmemory-linux-x64 --help

      - name: Cache Ollama
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-${{ env.OLLAMA_MODEL }}
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Install and start Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5

          if ! ollama list | grep -q "$OLLAMA_MODEL"; then
            ollama pull $OLLAMA_MODEL
          fi
          ollama list

      - name: Verify Qdrant is running
        run: |
          curl -f http://localhost:6333/readyz
          echo "Qdrant is ready"

      - name: Test doctor command (with dependencies)
        run: |
          export OLLAMA_HOST=http://localhost:11434
          export QDRANT_HOST=http://localhost:6333
          ./bin/mycelicmemory-linux-x64 doctor

      - name: Test in isolated environment (Docker)
        run: |
          docker run --rm -v $(pwd):/app -w /app ubuntu:22.04 bash -c '
            apt-get update && apt-get install -y ca-certificates
            chmod +x ./bin/mycelicmemory-linux-x64
            ./bin/mycelicmemory-linux-x64 --version
            ./bin/mycelicmemory-linux-x64 --help
            echo "Binary runs in clean Ubuntu container"
          '

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test npm installation from GitHub
        run: |
          npm install -g github:MycelicMemory/mycelicmemory#${{ github.sha }}
          mycelicmemory --version || echo "Version check with npm wrapper"

  # Test installation on clean Windows
  test-windows:
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows x64 binary
        uses: actions/download-artifact@v4
        with:
          name: mycelicmemory-windows-x64.exe
          path: ./bin

      - name: Test binary execution
        shell: pwsh
        run: |
          ./bin/mycelicmemory-windows-x64.exe --version
          ./bin/mycelicmemory-windows-x64.exe --help

      - name: Cache Ollama
        uses: actions/cache@v4
        with:
          path: ~\.ollama
          key: ${{ runner.os }}-ollama-${{ env.OLLAMA_MODEL }}
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Install and start Ollama
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://ollama.com/download/ollama-windows-amd64.exe" -OutFile "ollama.exe"
          Start-Process -FilePath ".\ollama.exe" -ArgumentList "serve" -NoNewWindow
          Start-Sleep -Seconds 10

          .\ollama.exe pull $env:OLLAMA_MODEL
          .\ollama.exe list

      - name: Start Qdrant (Docker)
        shell: pwsh
        run: |
          docker run -d -p 6333:6333 -p 6334:6334 qdrant/qdrant:latest
          Start-Sleep -Seconds 10

          for ($i = 0; $i -lt 30; $i++) {
            try {
              Invoke-RestMethod -Uri "http://localhost:6333/readyz" -TimeoutSec 5
              Write-Host "Qdrant is ready!"
              break
            } catch {
              Start-Sleep -Seconds 1
            }
          }

      - name: Test doctor command (with dependencies)
        shell: pwsh
        env:
          OLLAMA_HOST: http://localhost:11434
          QDRANT_HOST: http://localhost:6333
        run: |
          ./bin/mycelicmemory-windows-x64.exe doctor
        continue-on-error: true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test npm installation from GitHub
        shell: pwsh
        run: |
          npm install -g "github:MycelicMemory/mycelicmemory#${{ github.sha }}"
          mycelicmemory --version

  # Test MCP server functionality
  test-mcp-server:
    needs: build
    runs-on: ubuntu-latest
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
          - 6334:6334
        options: >-
          --health-cmd "curl -f http://localhost:6333/readyz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: mycelicmemory-linux-x64
          path: ./bin

      - name: Cache Ollama
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-${{ env.OLLAMA_MODEL }}
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Install and start Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5

          if ! ollama list | grep -q "$OLLAMA_MODEL"; then
            ollama pull $OLLAMA_MODEL
          fi

      - name: Test MCP server starts
        run: |
          chmod +x ./bin/mycelicmemory-linux-x64
          export OLLAMA_HOST=http://localhost:11434
          export QDRANT_HOST=http://localhost:6333
          # Start MCP server in background and test it responds
          timeout 5 ./bin/mycelicmemory-linux-x64 --mcp < /dev/null || true
          echo "MCP server started and exited cleanly"

      - name: Test MCP protocol
        run: |
          chmod +x ./bin/mycelicmemory-linux-x64
          export OLLAMA_HOST=http://localhost:11434
          export QDRANT_HOST=http://localhost:6333
          # Send initialize request
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' | \
            timeout 5 ./bin/mycelicmemory-linux-x64 --mcp 2>/dev/null | head -1 || true
          echo "MCP protocol test complete"

  # Summary job
  installation-test-summary:
    needs: [test-macos, test-linux, test-windows, test-mcp-server]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Installation Test Results:"
          echo "=========================="
          echo "macOS: ${{ needs.test-macos.result }}"
          echo "Linux: ${{ needs.test-linux.result }}"
          echo "Windows: ${{ needs.test-windows.result }}"
          echo "MCP Server: ${{ needs.test-mcp-server.result }}"

          if [ "${{ needs.test-macos.result }}" != "success" ] || \
             [ "${{ needs.test-linux.result }}" != "success" ] || \
             [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "One or more installation tests failed!"
            exit 1
          fi

          echo "All installation tests passed!"
