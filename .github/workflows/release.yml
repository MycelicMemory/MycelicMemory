name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.1)'
        required: true
        type: string

env:
  CGO_ENABLED: 1
  BUILD_TAGS: fts5

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - goarch: arm64
            name: mycelicmemory-macos-arm64
          - goarch: amd64
            name: mycelicmemory-macos-x64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
          cache-dependency-path: go.sum

      # Enhanced caching for Go build cache
      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ matrix.goarch }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-

      - name: Build
        env:
          GOARCH: ${{ matrix.goarch }}
          GOOS: darwin
        run: |
          go build -tags "$BUILD_TAGS" -ldflags "-s -w" -o ${{ matrix.name }} ./cmd/mycelicmemory
          chmod +x ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          compression-level: 9

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            name: mycelicmemory-linux-x64
          - goarch: arm64
            name: mycelicmemory-linux-arm64
            cc: aarch64-linux-gnu-gcc
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
          cache-dependency-path: go.sum

      # Enhanced caching for Go build cache
      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ matrix.goarch }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-

      - name: Install cross-compiler (arm64)
        if: matrix.goarch == 'arm64'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        env:
          GOARCH: ${{ matrix.goarch }}
          GOOS: linux
          CC: ${{ matrix.cc || 'gcc' }}
        run: |
          go build -tags "$BUILD_TAGS" -ldflags "-s -w" -o ${{ matrix.name }} ./cmd/mycelicmemory
          chmod +x ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          compression-level: 9

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            name: mycelicmemory-windows-x64.exe
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
          cache-dependency-path: go.sum

      # Enhanced caching for Go build cache
      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\go-build
            ~\go\pkg\mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ matrix.goarch }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-

      - name: Build
        env:
          GOARCH: ${{ matrix.goarch }}
          GOOS: windows
        run: |
          go build -tags "${{ env.BUILD_TAGS }}" -ldflags "-s -w" -o ${{ matrix.name }} ./cmd/mycelicmemory

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          compression-level: 9

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release files
        run: |
          mkdir -p release
          for dir in dist/*/; do
            binary=$(ls "$dir")
            cp "$dir$binary" "release/$binary"
          done
          ls -la release/

      - name: Generate SHA256 checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS

      - name: Import GPG key
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "=== GPG Keys ==="
          gpg --list-secret-keys

      - name: Sign checksums with GPG
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          cd release
          gpg --batch --yes --detach-sign --armor SHA256SUMS
          echo "=== Signed Files ==="
          ls -la SHA256SUMS*

      - name: Create verification scripts
        run: |
          cat > release/verify.sh << 'EOFSH'
          #!/bin/bash
          # MycelicMemory Binary Verification Script
          set -e
          BINARY="$1"
          if [ -z "$BINARY" ]; then
            echo "Usage: $0 <binary-file>"
            exit 1
          fi
          echo "Verifying $BINARY..."
          if command -v sha256sum >/dev/null 2>&1; then
            EXPECTED=$(grep "$BINARY" SHA256SUMS | awk '{print $1}')
            ACTUAL=$(sha256sum "$BINARY" | awk '{print $1}')
            if [ "$EXPECTED" = "$ACTUAL" ]; then
              echo "✅ SHA256 verified"
            else
              echo "❌ SHA256 mismatch!"
              exit 1
            fi
          fi
          if [ -f "SHA256SUMS.asc" ] && command -v gpg >/dev/null 2>&1; then
            gpg --verify SHA256SUMS.asc SHA256SUMS 2>&1 | grep -q "Good signature" && \
              echo "✅ GPG verified" || echo "⚠️  GPG verification failed"
          fi
          echo "✅ Verification complete"
          EOFSH

          chmod +x release/verify.sh

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ steps.version.outputs.version }}';

            // Try to get draft release notes from Release Drafter
            let body = '';
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const draftRelease = releases.find(r => r.draft);
              if (draftRelease && draftRelease.body) {
                body = draftRelease.body;
              }
            } catch (error) {
              console.log('No draft release found, using default template');
            }

            // Fallback to default template if no draft
            if (!body) {
              body = `## MycelicMemory ${version}

            AI-powered persistent memory system for Claude and other AI agents.

            ### Installation

            **Via npm (recommended):**
            \`\`\`bash
            npm install -g mycelicmemory
            \`\`\`

            **Direct download:**
            Download the binary for your platform below and add it to your PATH.

            ### Platform Binaries

            | Platform | Architecture | Binary |
            |----------|--------------|--------|
            | macOS | Apple Silicon (M1/M2/M3) | \`mycelicmemory-macos-arm64\` |
            | macOS | Intel | \`mycelicmemory-macos-x64\` |
            | Linux | x64 | \`mycelicmemory-linux-x64\` |
            | Linux | ARM64 | \`mycelicmemory-linux-arm64\` |
            | Windows | x64 | \`mycelicmemory-windows-x64.exe\` |`;
            }

            fs.writeFileSync('release-notes.md', body);
            return body;

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: MycelicMemory ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
